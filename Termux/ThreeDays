#!/usr/bin/env bash

# some constant var
NVIM_ZIP_RAW="https://raw.githubusercontent.com/Tridays/command-tools/main/Termux/nvim/nvim.zip"
FONT_TAR_XZ_RAW="https://raw.githubusercontent.com/Tridays/command-tools/main/Termux/nvim/font.tar.xz"
JDK11_ZIP_RELEASE="https://github.com/WindowHZT/termux-ubuntu2004/releases/download/java-jdk-v11.0.12/openjdk-11.0.12-aarch64.zip"
DICT_ZIP_RELEASE="https://github.com/skywind3000/ECDICT-ultimate/releases/download/1.0.0/ecdict-ultimate-sqlite.zip"
NODEJS16_RAW="https://raw.githubusercontent.com/Tridays/command-tools/main/Termux/node/nodejs-16.19.1-aarch64.deb"
HMacMd5Utils_RAW="https://raw.githubusercontent.com/Tridays/command-tools/main/Termux/mmcd/HMacMd5Utils.java"
# 
FILE_BROWSER_TAR_GZ_RELEASE="https://github.com/filebrowser/filebrowser/releases/download/v2.23.0/linux-arm64-filebrowser.tar.gz"
UNBLOCK_NETEASE_MUSIC_CLONE="https://github.com/nondanee/UnblockNeteaseMusic"
MUSIC_DL_CLONE="https://github.com/0xHJK/music-dl.git"
WIKIJS_RELEASE="https://github.com/requarks/wiki/releases/download/v2.5.297/wiki-js.tar.gz"
WORDPRESS="https://cn.wordpress.org/wordpress-6.1.1-zh_CN.zip"
TOMCAT_RELEASE="https://github.com/WindowHZT/termux-ubuntu2004/releases/download/tomcat/tomcat.zip"
FISH_RAW="https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install"
SPEEDTEST_RAW="https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py"
#--------------------------------------------- 1çº§èœå•ç›®å½• ---------------------------------------------
# ç»ˆç«¯ç¾åŒ–
_fish(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}
			${GREEN}å®˜ç½‘ï¼š${WHITE}
			EOF
		)"
		# install fish
		if [ -n "$(dpkg -l | grep fish)" ];then
			_msg W "æœ¬åœ°å·²å®‰è£…fish"
			echo -en "${RED}æ˜¯å¦å¸è½½ï¼Ÿ[Y/N]${WHITE}" ""
			read op
			case $op in
			y|Y)
				_command "apt purge" "fish" "-y"
				;;
			*)
				return 0
				;;
			esac
		fi
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		yes | pkg update
		_command "pkg i -y" "fish"
		# font
		_command "-raw" "wget -c" "$FONT_TAR_XZ_RAW"
		xz -d font.tar.xz
		tar -xvf font.tar
		mv -f font.ttf $HOME/.termux
		rm -rf font.tar
		termux-reload-settings
		_msg W "å¦‚æœå­—ä½“æ˜¾ç¤ºä¸æ­£å¸¸ï¼Œè¯·ä½¿ç”¨ä¸‹é¢å‘½ä»¤é…ç½®å­—ä½“\ntermux-reload-settings"
		_msg I "å®‰è£…å®Œæˆï¼"
		_enter
	}
	_switch(){
		clear
		[ -z "$(dpkg -l | grep fish)"  ] && _msg E "è¯·å…ˆå®‰è£…fishï¼" && _enter && return 0
		OPTIONS=(
             "å¼€å¯"
             "å…³é—­")
		_dialog "é¦–é¡µâ†’ç»ˆç«¯ç¾åŒ–â†’fishâ†’å¼€å…³" "è¯·é€‰æ‹©" $OPTIONS
		case $op in
			1)
				_command "chsh -s fish"
				_enter
				;;
			2)
				_command "chsh -s bash"
				_enter
				;;
		esac
	}
	_theme(){
		clear
		[ -z "$(dpkg -l | grep fish)"  ] && _msg E "è¯·å…ˆå®‰è£…fishï¼" && _enter && return 0
    	shell=$(echo $SHELL | awk -F "/" '{print $NF}')    	
    	
    	# å®‰è£…omf
    	fish <<< "omf.index.query --type=theme" >/dev/null 2>&1
    	if [ ! "$?" == "0" ];then
	    	rm -rf "$HOME/.local/share/omf"
			mkdir -p $HOME/.cache/download
			cd $HOME/.cache/download
			rm -rf ./install
			_command "-raw" "wget -c" "$FISH_RAW" "-O $HOME/.cache/download/install"
			row=$(cat ./install | grep -n "exec" | awk -F ":" '{print $1}')
   			sed -i ${row}d ./install
   			fish ./install
    		cd $HOME
    	fi
		OPTIONS=($(fish <<< "omf.index.query --type=theme"))
		tmp=(${OPTIONS[*]})
		[ ${#tmp[@]} -lt 10 ] && _msg E "æœªæŸ¥è¯¢åˆ°ä¸»é¢˜ï¼Œè¯·é‡è¯•ï¼" && _enter && return 0

        _dialog "é¦–é¡µâ†’ç»ˆç«¯ç¾åŒ–â†’fishâ†’ä¸»é¢˜" "è¯·é€‰æ‹©" $OPTIONS
		v=${tmp[$(($op-1))]}
		OPTIONS=(
			"ä½¿ç”¨$vä¸»é¢˜"
			"ç§»é™¤$vä¸»é¢˜")
		_dialog "é¦–é¡µâ†’ç»ˆç«¯ç¾åŒ–â†’fishâ†’ä¸»é¢˜â†’å¯ç”¨/ç§»é™¤" "è¯·é€‰æ‹©" $OPTIONS
		case $op in
			1)
				clear
  			  	fish <<< "omf install $v"
  			  	if [ "$?" == "0" ];then
  			  		fish <<< "omf theme $v"
  			  	  	_msg W "é‡æ–°æ‰“å¼€ç»ˆç«¯ä¸»é¢˜ç”Ÿæ•ˆï¼"
  			  	else
	  			  	_msg W "ä¸»é¢˜ä¸‹è½½å¤±è´¥è¯·ç§‘å­¦ä¸Šç½‘ï¼"
  			  	fi
				_enter
				;;
			2)
				clear
  			  	fish <<< "omf remove $v"
  			  	_msg W "é‡æ–°æ‰“å¼€ç»ˆç«¯ç”Ÿæ•ˆï¼"
				_enter
				;;
		esac
	}
	OPTIONS=(
         "å®‰è£…ï½œå¸è½½fish"
         "å¯ç”¨ï½œå…³é—­"
         "ä¸»é¢˜"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’fish" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _switch
			;;
		3)
			_node _theme
			;;
		*)
			return 0
			;;
	esac
}



_style(){
    OPTIONS=(
         "èƒŒæ™¯é¢œè‰²"
         "å­—ä½“"
         "zsh"
         "fish"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
    _dialog "é¦–é¡µâ†’ç»ˆç«¯ç¾åŒ–" "è¯·é€‰æ‹©" $OPTIONS
	case $op in
		1)
			_msg W "åŠŸèƒ½æš‚æ—¶ä¸å¼€æ”¾"
			;;
		2)
			_msg W "åŠŸèƒ½æš‚æ—¶ä¸å¼€æ”¾"
			;;
		3)
			_msg W "åŠŸèƒ½æš‚æ—¶ä¸å¼€æ”¾"
			;;
		4)
			_node _fish
			;;
	esac    
}

# æ¢æº
_sources(){
		OPTIONS=(
			"å®˜æ–¹æºï¼ˆå›½å¤–ï¼‰"
			"æ¸…åæºï¼ˆå›½å†…ï¼‰"    
			"åŒ—äº¬å¤–å›½è¯­æºï¼ˆå›½å†…ï¼‰"    
			"é˜¿é‡Œæºï¼ˆå›½å†…ï¼‰"
			"ä¸­ç§‘å¤§æºï¼ˆå›½å†…ï¼‰"
			"<<è¿”å›ä¸Šçº§ç›®å½•>>")

    _dialog "é¦–é¡µâ†’æ›´æ¢æºsources.list" "è¯·é€‰æ‹©" $OPTIONS

	sourcesFile="/data/data/com.termux/files/usr/etc/apt/sources.list"
	case $op in
    	1)
			cat<<-EOF>$sourcesFile   ##å®˜æ–¹
			# The main termux repository, behind cloudflare cache:
			# deb https://packages-cf.termux.dev/apt/termux-main/ stable main
			# The main termux repository:
			deb https://packages.termux.dev/apt/termux-main/ stable main
			EOF
			;;
    	2)
			cat<<-EOF>$sourcesFile   ##æ¸…å
			# The termux repository mirror from TUNA:
			deb https://mirrors.tuna.tsinghua.edu.cn/termux/apt/termux-main stable main
			EOF
			;;
    	3)
			cat<<-EOF>"/data/data/com.termux/files/usr/etc/apt/sources.list"  ##åŒ—äº¬å¤–å›½è¯­
			# The main termux repository, behind cloudflare cache:
			# deb https://packages-cf.termux.dev/apt/termux-main/ stable main
			# The main termux repository:
			#deb https://packages.termux.dev/apt/termux-main/ stable main
			deb https://mirrors.bfsu.edu.cn/termux/apt/termux-main stable main
			EOF
			;;
    	4)
			cat<<-EOF>$sourcesFile
			# The termux repository mirror from aliyun:
			deb https://mirrors.aliyun.com/termux/termux-packages-24 stable main
			EOF
			;;
    	5)
			cat<<-EOF>$sourcesFile
			# The termux repository mirror from ustc:
			deb https://mirrors.ustc.edu.cn/termux/apt/termux-main stable main
			EOF
			;;
    	*)
			return 0
			;;
	esac
	clear
	_msg I "æ›´æ¢æˆåŠŸï¼"
	_msg W "å¦‚æœç½‘é€Ÿä¸èƒ½è·‘æ»¡ä½ çš„å®½å¸¦ç½‘ç»œï¼Œè¯·æ›´æ¢å…¶ä»–æº"
	_enter
}



#--------------------------------------------- 2çº§èœå•ç›®å½• ---------------------------------------------

_filebrowser(){
	filebrowserPath="$PREFIX/opt/filebrowser"
	_i(){
		clear
		echo -e "\n\n$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}filebrowseråœ¨æŒ‡å®šç›®å½•ä¸­æä¾›äº†ä¸€ä¸ªwebæ–‡ä»¶ç®¡ç†ç•Œé¢ï¼Œå®ƒå¯ä»¥ç”¨äºä¸Šä¼ ã€åˆ é™¤ã€é¢„è§ˆã€é‡å‘½åå’Œç¼–è¾‘æ–‡ä»¶ã€‚
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://github.com/filebrowser/filebrowser
			EOF
		)"
		# install filebrowser
		_checkInstall "$filebrowserPath"  && pkill -9 filebrowser && rm -rf "$PREFIX/var/service/filebrowser" || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		mkdir -p $filebrowserPath
		cd $filebrowserPath
		_command "-release" "wget -c " "$FILE_BROWSER_TAR_GZ_RELEASE" " -O filebrowser.tar.gz"
		tar -zxvf filebrowser.tar.gz
		chmod +x filebrowser
		rm filebrowser.tar.gz
		$filebrowserPath/filebrowser -d $filebrowserPath/filebrowser.db config init 
		$filebrowserPath/filebrowser users add root 123456 --perm.admin -d $filebrowserPath/filebrowser.db 
		$filebrowserPath/filebrowser -d $filebrowserPath/filebrowser.db config set --address 127.0.0.1 --port 1234 --root "$HOME" --locale zh-cn 
		_msg I "å®‰è£…å®Œæˆï¼"
		_enter
	}
	_start(){
		clear
		[ ! -e "$filebrowserPath" ] && _msg E "è¯·å…ˆå®‰è£…filebrowserï¼" && _enter && return 0
		path="$PREFIX/var/service/filebrowser"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			exec $filebrowserPath/filebrowser -d $filebrowserPath/filebrowser.db 
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable filebrowser"
		echo -e "${GREEN}è®¿é—®ç½‘å€ï¼šhttp://127.0.0.1:1234${WHITE}"
		echo -e "${GREEN} è´¦å·ï¼šroot å¯†ç ï¼š123456${WHITE}"
		_enter
	}
	_stop(){
		[ ! -e "$filebrowserPath" ] && _msg E "è¯·å…ˆå®‰è£…filebrowserï¼" && _enter && return 0
		_command "sv-disable filebrowser"
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½filebrowser"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’filebrowser" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}
_UnblockNeteaseMusic(){
	p="$PREFIX/opt/UnblockNeteaseMusic"
	##è§£é”ç½‘æ˜“äº‘
	i(){
		_checkInstall "$p"
		mkdir -p $PREFIX/opt
		cd $PREFIX/opt
		[ -z "$(command -v node)" ]&&_command "pkg i -y" "nodejs"
		[ -z "$(command -v git)" ]&&_command "pkg i -y" "git"
		_command "-clone" "git clone --depth 1" "$UNBLOCK_NETEASE_MUSIC_CLONE"
		echo -e "${GREEN}å®‰è£…å®Œæˆ!${WHITE}"
		_enter
	}
	start(){
		clear
		[ ! -e "$p" ]&&echo -e "${YELLOW}è¯·å…ˆå®‰è£…UnblockNeteaseMusicï¼${WHITE}"&&_enter&&return
		path="$PREFIX/var/service/UnblockNeteaseMusic"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			node $p/app.js -p 8008 -a 127.0.0.1 
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable UnblockNeteaseMusic"
		echo -e "$(
		cat <<-EOF
			â—WiFiä»£ç†ï¼šè®¾ç½®â†’WiFiâ†’é€‰æ‹©è¿æ¥çš„WiFiâ†’é«˜çº§è®¾ç½®â†’ä»£ç†ï¼ˆPACï¼‰
			    http://127.0.0.1:8008/proxy.pac
		EOF
		)"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter

	}
	stop(){
		[ ! -e "$p" ]&&echo -e "${YELLOW}è¯·å…ˆå®‰è£…UnblockNeteaseMusicï¼${WHITE}"&&_enter&&return
		_command "sv-disable UnblockNeteaseMusic"
		_enter
	}
	    OPTIONS=(
 	        "å®‰è£…ï½œå¸è½½UnblockNeteaseMusic"
	        "å¼€å¯"
	        "å…³é—­"
	        "<<è¿”å›ä¸Šçº§ç›®å½•>>")
	    _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’UnblockNeteaseMusicè§£é”ç½‘æ˜“äº‘" "è¯·é€‰æ‹©" $OPTIONS
	    case $op in
	    	1)
	    		i
	    		;;
	    	2)
	    		start
	    		;;
	    	3)
	    		stop
	    		;;
	    	*)
    			return 0
    			;;
	    esac	
}
_music-dl(){
	path=$PREFIX/opt/music-dl
	i(){
		_checkInstall $path
		[ ! "$?" == "0" ] && return 0
		[ -z "$(command -v python)" ]&&_command "pkg i -y" "python"
		[ -z "$(command -v git)" ]&&_command "pkg i -y" "git"
		mkdir -p $PREFIX/opt
		cd $PREFIX/opt
		_command "-clone" "git clone --depth 1 " "$MUSIC_DL_CLONE"
		cd music-dl
		pip3 install -r requirements.txt
		_enter
	}
	start(){
		[ ! -e "$path" ] && echo -e "${YELLOW}è¯·å…ˆå®‰è£…music-dlï¼${WHITE}" && _enter && return
		cd $path
		_command "./music-dl --help"
		_command "./music-dl"
		_enter
	}
	    OPTIONS=(
 	        "å®‰è£…ï½œå¸è½½Music-dl"
	        "ä¸‹è½½éŸ³ä¹"
	        "<<è¿”å›ä¸Šçº§ç›®å½•>>")
	    _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’å…¨ç½‘éŸ³ä¹ä¸‹è½½music-dl" "è¯·é€‰æ‹©" $OPTIONS
	    case $op in
	    	1)
	    		_node i
	    		;;
	    	2)
	    		start
	    		;;
	    	*)
    			return 0
  		  		;;
	    esac	
}

_vscode-server(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}åŸºäºvscode.devçš„ç½‘é¡µç‰ˆvscodeå¼€å‘äº†å®˜æ–¹çš„code-server
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://github.com/coder/code-server
			EOF
		)"
		# install TreeSoft
		if [ -n "$(dpkg -l | grep code-server)" ];then
			_msg W "æœ¬åœ°å·²å®‰è£…VScode-server"
			echo -en "${RED}æ˜¯å¦å¸è½½ï¼Ÿ[Y/N]${WHITE}" ""
			read op
			case $op in
			y|Y)
				pkill -9 code-server
				_command "apt purge" "code-server" "-y"
				rm -rf "$PREFIX/var/service/VScode-server"
				;;
			*)
				return 0
				;;
			esac
		fi
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		yes | pkg update
		_command "pkg i -y" "tur-repo code-server"
		_config
		_msg I "å®‰è£…å®Œæˆï¼"
		_enter
	}
	_start(){
		clear
		[ -z "$(dpkg -l | grep code-server)"  ] && _msg E "è¯·å…ˆå®‰è£…VScode-serverï¼" && _enter && return 0
		path="$PREFIX/var/service/VScode-server"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			code-server
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable VScode-server"
		echo -e "${YELLOW}\n-------------VScode-serveré…ç½®æ–‡ä»¶-------------${WHITE}"
		cat $HOME/.config/code-server/config.yaml
		echo -e "${YELLOW}---------------------------------------------------${WHITE}"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter
	}
	_stop(){
		[ -z "$(dpkg -l | grep code-server)"  ] && _msg E "è¯·å…ˆå®‰è£…VScode-serverï¼" && _enter && return 0
		_command "sv-disable VScode-server"
		_enter
	}
	_config(){
		[ -z "$(dpkg -l | grep code-server)"  ] && _msg E "è¯·å…ˆå®‰è£…VScode-serverï¼" && _enter && return 0
		address=$(dialog --clear --title "code-serverè¿æ¥åœ°å€" \
		--inputbox "è¾“å…¥ä½ çš„åœ°å€(ä¸å¡«ä¸ºé»˜è®¤å€¼)
		([é»˜è®¤127.0.0.1])" 8 50 \
		3>&1 1>&2 2>&3 3>&-)
		[ -z "$address" ]&&address=127.0.0.1
		
		port=$(dialog --clear --title "code-serverè¿æ¥ç«¯å£" \
		--inputbox "è¾“å…¥ä½ çš„ç«¯å£(ä¸å¡«ä¸ºé»˜è®¤å€¼)
		([é»˜è®¤8050])" 8 50 \
		3>&1 1>&2 2>&3 3>&-)
		[ -z "$port" ]&&port=8050
		
		password=$(dialog --clear --title "code-serverè¿æ¥å¯†ç " \
		--inputbox "è¾“å…¥ä½ çš„å¯†ç (ä¸å¡«ä¸ºé»˜è®¤å€¼)
		([é»˜è®¤ï¼šæ— ])" 8 50 \
		3>&1 1>&2 2>&3 3>&-)
		
		auth=none
		[ -n "$password" ]&&auth=password
		
		cat<<-EOF > $HOME/.config/code-server/config.yaml
		bind-addr: $address:$port
		auth: $auth
		password: $password
		cert: false
		EOF
		echo -e "${YELLOW}\n-------------code-serveré…ç½®æ–‡ä»¶-------------${WHITE}"
		cat $HOME/.config/code-server/config.yaml
		echo -e "${YELLOW}---------------------------------------------------${WHITE}"
		echo -e "${GREEN}å°æç¤ºï¼šå…³é—­åå¯åŠ¨é…ç½®ç”Ÿæ•ˆ${WHITE}"
		_enter
	}

    OPTIONS=(
         "å®‰è£…ï½œå¸è½½VScode-server"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "ä¿®æ”¹é…ç½®æ–‡ä»¶"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’VScode-server" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		4)
			_node _config
			;;		
		*)
			return 0
			;;
	esac

}

_Alist(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}ä¸€æ¬¾æ”¯æŒå¤šç§å­˜å‚¨çš„ç›®å½•æ–‡ä»¶åˆ—è¡¨ç¨‹åºï¼Œæ”¯æŒ web æµè§ˆä¸ webdavï¼Œåç«¯åŸºäºginï¼Œå‰ç«¯ä½¿ç”¨reactã€‚
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://github.com/alist-org/alist
			EOF
		)"
		# install TreeSoft
		if [ -n "$(dpkg -l | grep alist)" ];then
			_msg W "æœ¬åœ°å·²å®‰è£…Alist"
			echo -en "${RED}æ˜¯å¦å¸è½½ï¼Ÿ[Y/N]${WHITE}" ""
			read op
			case $op in
			y|Y)
				pkill -9 alist
				_command "apt purge" "alist" "-y"
				rm -rf "$PREFIX/var/service/Alist"
				rm -rf $PREFIX/bin/data
				;;
			*)
				return 0
				;;
			esac
		fi
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		yes | pkg update
		_command "pkg i -y" "alist"
		_msg I "å®‰è£…å®Œæˆï¼"
		_enter
	}
	_start(){
		clear
		[ -z "$(dpkg -l | grep alist)"  ] && _msg E "è¯·å…ˆå®‰è£…Alistï¼" && _enter && return 0
		path="$PREFIX/var/service/Alist"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/{log,data}
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			alist server --data $PREFIX/var/service/Alist/data
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable Alist"
		echo -e "${YELLOW}\n-------------é…ç½®ä¿¡æ¯-------------${WHITE}"
		alist admin --data $PREFIX/var/service/Alist/data
		cat $PREFIX/var/service/Alist/data/config.json | grep port
		echo -e "${YELLOW}---------------------------------------------------${WHITE}"	
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter
	}
	_stop(){
		clear
		[ -z "$(dpkg -l | grep alist)"  ] && _msg E "è¯·å…ˆå®‰è£…Alistï¼" && _enter && return 0
		_command "sv-disable Alist"
		_enter
	}
	OPTIONS=(
         "å®‰è£…ï½œå¸è½½Alist"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’Alist" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}



_vimIDE(){
	coc(){
		mkdir -p ~/.vim/{autoload,plugged}  ~/.config/coc/extensions/coc-java-data/server/
		download " -c https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim -O $HOME/.vim/autoload/plug.vim"
		cd ~/.vim/plugged
		## å®‰è£…cocæ‰©å±•
		git clone --branch release https://github.com/neoclide/coc.nvim
		download "wget -c https://download.eclipse.org/jdtls/snapshots/jdt-language-server-latest.tar.gz -O ./jdt.tar.gz"
		#å°†jdt.lsçš„åŒ…è§£å‹åˆ°è¿™ä¸ªç›®å½•ä¸‹  
		tar -xzvf jdt.tar.gz -C ~/.config/coc/extensions/coc-java-data/server/
		rm -rf .git jdt.tar.gz
		cat<<-EOF>~/.vimrc
		call plug#begin('~/.vim/plugged') "æ’ä»¶é…ç½®ç›®å½•
		Plug 'neoclide/coc.nvim', {'branch': 'release'} " cocæ’ä»¶ç®¡ç†
		Plug 'honza/vim-snippets' " æä¾›å¼ºå¤§çš„ä»£ç å—
		Plug 'yianwillis/vimcdoc' " ä¸­æ–‡æ–‡æ¡£ï¼ˆvimcdocï¼‰
		Plug 'altercation/vim-colors-solarized' " ä¸»é¢˜ï¼ˆvim-colors-solarizedï¼‰
		Plug 'scrooloose/nerdtree' " ç›®å½•æ ‘(NERDTree)
		Plug 'preservim/tagbar' " æ ‡ç­¾å¯¼èˆªï¼ˆTagbarï¼‰
		Plug 'vim-scripts/taglist.vim' " æ ‡ç­¾åˆ—è¡¨(taglist.vim)
		Plug 'vim-airline/vim-airline' " çŠ¶æ€æ ä¼˜åŒ–ï¼ˆvim-airlineï¼‰
		Plug 'scrooloose/nerdcomm_enter' " æ‰¹é‡æ³¨é‡Šï¼ˆnerdcomm_enterï¼‰
		Plug 'Yggdroot/indentLine'
		call plug#end()
		EOF
		
		echo -e "${YELLOW}é¢„å®‰è£…Javaã€C/C++ã€Pythonã€Goã€Webã€MySQLã€bashã€vimscriptå¼€å‘æ’ä»¶${WHITE}"
		echo -e "${YELLOW}è‹¥å®‰è£…å¤±è´¥ï¼ˆå‡ºç°çº¢è‰²Ã—ï¼‰ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ vim -c :PlugInstall æˆ–å°è¯•è¾“å…¥ R é‡æ–°ä¸‹è½½${WHITE}"
		echo -e "${GREEN}æ›´å¤šæ’ä»¶è¯·è®¿é—®https://github.com/neoclide/coc.nvim/wiki/Using-coc-extensions${WHITE}"
		_enter
		# é…åˆneocomplete
		#vim -c :"CocInstall coc-java coc-snippets coc-clangd coc-python coc-go coc-html coc-emmet coc-tsserver coc-css coc-sql coc-sh coc-vimlsp " a
		vim -c :PlugInstall
	}
	ycm(){
		cat<<-EOF>~/.vimrc
		call plug#begin('~/.vim/plugged') "æ’ä»¶é…ç½®ç›®å½•
		Plug 'valloric/YouCompleteMe'
		call plug#end()
		EOF
		vim -c :PluginInstall
		cd 
		
		##å¦‚æœæƒ³è¡¥å…¨å„ç§è¯­è¨€ï¼Œåˆ™é€‰æ‹©å®Œå…¨å®‰è£…ï¼š
		##python3 install.py --all
		##å¦‚æœåªæƒ³è¡¥å…¨æŒ‡å®šè¯­è¨€ï¼Œåˆ™éœ€è¦æŒ‡å®šå¯¹åº”è¯­è¨€çš„å®‰è£…æ–¹å¼ï¼Œå¦‚è¡¥å…¨C++ï¼š
		##python3 install.py --clangd-completer
		##æˆ–è¡¥å…¨C#ï¼š
		##python3 install.py --cs-completer
		##æˆ–è¡¥å…¨Javaï¼š
		##python3 install.py --java-completer
		##æˆ–è¡¥å…¨Goï¼š
		##python3 install.py --go-completer
	}
	main(){
	    OPTIONS=(
	         "vim-plug+cocä»£ç è¡¥å…¨"
	         "vim-plug+ycmä»£ç è¡¥å…¨"
	         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
 	   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’Vim IDE" "è¯·é€‰æ‹©" $OPTIONS
	    case $op in
    		1)
    			coc
    			;;
    		2)
    			ycm
    			;;
    		*)
    			return
    			;;
    	esac

	}
	_check "git" "wget" 
	main
}

_nvimIDE(){
	_i(){
		clear
		echo -e "$(
			cat <<-EOF
			\n\nï½€ï½€ï½€ï½€ï½€ï½€ï½€ï½€ï½€${YELLOW} neovim IDE é…ç½®æ–¹æ¡ˆ ${WHITE}ï½€ï½€ï½€ï½€ï½€ï½€ï½€ï½€ï½€
			--${GREEN}è½¯ä»¶${WHITE}
			    nvim
			--${GREEN}åŸºæœ¬æ’ä»¶${WHITE}
			    â—wbthomason/packer.nvim æ’ä»¶åŒ…ç®¡ç†å™¨
			    â—folke/tokyonight.nvim  ä¸»é¢˜
			    â—nvim-lualine/lualine.nvim  åº•éƒ¨çŠ¶æ€æ 
			    â—kyazdani42/nvim-web-devicons  æä¾›ç‰¹æ®Šå›¾æ ‡å­—ä½“æ”¯æŒ
			    â—nvim-tree/nvim-tree.lua   æ–‡æ¡£æ ‘
			    â—nvim-tree/nvim-web-devicons treeç‰¹æ®Šå›¾æ ‡å­—ä½“æ”¯æŒ
			    â—nvim-treesitter/nvim-treesitter  æ ¹æ®ä»£ç è¿›è¡Œè¯­æ³•é¢œè‰²åŒºåˆ†
			    â—p00f/nvim-ts-rainbow  ä¸åŒçš„æ–¹æ³•å’Œç±»ï¼Œæ‹¬å·ç”¨ä¸åŒçš„é¢œè‰²åŒºåˆ†
			    â—akinsho/toggleterm.nvim  æµ®åŠ¨ç»ˆç«¯
			    â—glepnir/dashboard-nvim  å¯åŠ¨é¡µé¢
			--${GREEN}ï¼ŠJava LspæœåŠ¡å™¨${WHITE}
			    â—mfussenegger/nvim-jdtls   é’ˆå¯¹Java Lspï¼Œç”¨äºæ”¯æŒeclipse.jdt.lsçš„æ‰©å±•
			    â—williamboman/mason.nvim   lspå’Œdapçš„ä¸‹è½½å™¨ä¸ç®¡ç†
			    â—williamboman/mason-lspconfig.nvim  è¿æ¥mason.nvimä¸nvim-lspconfigçš„ä¸­é—´æ’ä»¶
			    â—neovim/nvim-lspconfig   lspå®¢æˆ·ç«¯ï¼ˆxç§»å¼ƒï¼‰
			    â—folke/lsp-colors.nvim  ä¸ºlspå®¢æˆ·ç«¯è®¾ç½®é…è‰²æ–¹æ¡ˆ
			    â—glepnir/lspsaga.nvim  è½»é‡çº§Lspæ’ä»¶ï¼Œå…·æœ‰é«˜æ€§èƒ½UIï¼ŒåŠŸèƒ½éå¸¸å¼ºï¼ˆæ˜¾ç¤ºç±»ã€æ–¹æ³•ä¿¡æ¯ï¼Œæ ¹æ®ä»£ç åˆ›å»ºå¤§çº²ï¼Œç¯æ³¡ğŸ’¡æç¤ºï¼Œæµ®åŠ¨ç»ˆç«¯ç­‰ç­‰ï¼‰
			    â—hrsh7th/cmp-nvim-lsp-signature-help   Lspæ’ä»¶ï¼ŒåŠŸèƒ½:æç¤ºæ–¹æ³•ï¼Œå‡½æ•°çš„å‚æ•°éœ€è¦
			    â—j-hui/fidget.nvim  jdtlså³ä¸‹è§’ä¿¡æ¯æç¤º
			--${GREEN}ä»£ç è¡¥å…¨${WHITE}
			    â—hrsh7th/nvim-cmp   ä»£ç è¡¥å…¨æ ¸å¿ƒæ’ä»¶
			    â—hrsh7th/cmp-nvim-lsp  æ ¹æ®lspæœåŠ¡å™¨è¿›è¡Œè¡¥å…¨æç¤º
			    â—hrsh7th/cmp-cmdline  nvimå‘½ä»¤è¡Œæ¨¡å¼æç¤º
			    â—f3fora/cmp-spell  è‹±è¯­å•è¯æ‹¼å†™è¾…åŠ©
			    â—hrsh7th/cmp-path  è·¯å¾„è¡¥å…¨æ”¯æŒ
			    â—hrsh7th/cmp-buffer  nvim-cmpçš„ç¼“å†²è¯æ¥æº
			    â—windwp/nvim-autopairs  è‡ªåŠ¨è¡¥å…¨æ‹¬å·ï¼ˆè¾“å…¥å·¦æ‹¬å·ï¼Œå…‰æ ‡ç§»åŠ¨åˆ°ä¸­é—´ï¼Œè¾“å…¥å³æ‹¬å·ï¼Œè·³å‡ºæ‹¬å·ï¼‰
			    â—tzachar/cmp-tabnine  AIè¡¥å…¨ï¼ˆæš‚æ—¶æ²¡æœ‰å…¨éƒ¨æ”¯æŒaarch64ï¼‰
			    â—L3MON4D3/LuaSnip   ä»£ç å—
			    â—saadparwaiz1/cmp_luasnip  ä»£ç å—æ”¯æŒFor luasnip users.
			    â—rafamadriz/friendly-snippets   ä»£ç å—
			    â—jose-elias-alvarez/null-ls.nvim  ä»£ç æ ¼å¼åŒ–
			--${GREEN}ï¼Šdapä»£ç è°ƒè¯•${WHITE}
			    â—mfussenegger/nvim-dap  ä»£ç è°ƒè¯•debug
			    â—rcarriga/cmp-dap  ä»£ç è°ƒè¯•
			    â—rcarriga/nvim-dap-ui  è°ƒè¯•é¡µé¢æ”¯æŒ
			    â—theHamsta/nvim-dap-virtual-text   æ­¤æ’ä»¶ä¸º nvim-dap æ·»åŠ äº†è™šæ‹Ÿæ–‡æœ¬æ”¯æŒ
			--${GREEN}å…¶ä»–éƒ¨åˆ†æ’ä»¶${WHITE}
			    â—folke/which-key.nvim  å¿«æ·é”®æç¤º
			    â—numToStr/Comment.nvim  è‡ªåŠ¨æ³¨é‡Šä»£ç 
			    â—akinsho/bufferline.nvim  é¡¶éƒ¨æ˜¾ç¤ºbufferç¼“å†²åŒº
			    â—lewis6991/gitsigns.nvim  å·¦åˆ™Gitæç¤º
			    â—nvim-telescope/telescope.nvim  é«˜åº¦å¯æ‰©å±•çš„æ¨¡ç³ŠæŸ¥æ‰¾å™¨
			    â—nvim-lua/plenary.nvim  telescope.nvimå¿…é¡»çš„ä¾èµ–æ’ä»¶
			    â—chentoast/marks.nvim  ä¸€ä¸ªè¡Œæ ‡è®°
			    â—#norcalli/nvim-colorizer   é«˜æ€§èƒ½çš„é«˜äº®æ’ä»¶(æš‚æ—¶è€ƒè™‘å¯ç”¨æ€§)
			    â—JuanZoran/Trans.nvim   è‹±æ–‡ç¿»è¯‘ï¼ˆå•è¯åŒ…128Mè§£å‹â‰ˆ1.2Gï¼‰
			    â—kkharji/sqlite.lua  ç¿»è¯‘æ•°æ®åº“ä¾èµ–
			EOF
		)"
		_enter
		_msg W "å½“å‰æºå·²åˆ‡æ¢åˆ°å¤–å›½è¯­å­¦é™¢"
		mkdir -p $HOME/{.vim/dict,.config}
		cat<<-EOF>"/data/data/com.termux/files/usr/etc/apt/sources.list"  ##åŒ—äº¬å¤–å›½è¯­
			# The main termux repository, behind cloudflare cache:
			# deb https://packages-cf.termux.dev/apt/termux-main/ stable main
			# The main termux repository:
			#deb https://packages.termux.dev/apt/termux-main/ stable main
			deb https://mirrors.bfsu.edu.cn/termux/apt/termux-main stable main
		EOF

		yes | pkg update
		_command "pkg i " "tar zip neovim git zig python nodejs openjdk-17* wget stylua maven gradle lua53 ripgrep termux-api clang lua-language-server php apache2 nginx php-fpm php-apache yarn graphviz tree golang composer" " -y"
		_command "npm install -g " " eslint clangd bash-language-server vscode-langservers-extracted typescript typescript-language-server"
		_command "pip install "  " black spell autopep8 prettier flake8 debugpy ptvsd neovim"
		
		##ä¸‹è½½nvimé…ç½®
		cd $HOME/.config
		_command "-raw" "wget -c" "$NVIM_ZIP_RAW"
		_command "-raw" "wget -c" "$FONT_TAR_XZ_RAW"
		unzip -o nvim.zip
		xz -d font.tar.xz
		tar -xvf font.tar
		mv font.ttf $HOME/.termux
		rm -rf nvim.zip font.tar
		
		##ä»githubä¸‹è½½æ’ä»¶
		_msg I "è¯·ç¡®ä¿ä½ çš„ç½‘ç»œèƒ½å¤Ÿè®¿é—®åˆ° http://github.com ï¼"
		_enter
		
		##ä¸‹è½½jdk11
		if [  ! -e "$PREFIX/opt/openjdk-11.0.12" ];then
			cd $PREFIX/opt
			_command "-release" "wget -c" "$JDK11_ZIP_RELEASE"
			unzip -o openjdk-11.0.12-aarch64.zip
			rm -rf openjdk-11.0.12-aarch64.zip
		fi
		
		##ä¸‹è½½ç¦»çº¿å•è¯åŒ… 
		if test -e "$HOME/.vim/dict/ultimate.db"; then
		    _msg W "å•è¯åº“å·²å­˜åœ¨è·³è¿‡ä¸‹è½½ï¼"
		else
			cd $HOME/.vim/dict
			_command "-release" "wget -c" "$DICT_ZIP_RELEASE" "-O dict.zip"
			unzip dict.zip 
			rm -rf dict.zip
		fi
		echo "extra-keys = [['ESC','/','-','HOME','UP','END','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','SHIFT']] " > $HOME/.termux/termux.properties
		
		_msg W "å…¨å±æ¨¡å¼ä¼šå±è”½æ‰‹æœºçŠ¶æ€æ ï¼Œå¹¶ä¸”åœ¨æŸäº›è®¾å¤‡ä¸Šæœ‰bugï¼Œä¸ä¸€å®šä¼šæˆåŠŸ"
		_enter
	    OPTIONS=(
         "éœ€è¦æ²‰æµ¸æ¨¡å¼"
         "ä¸éœ€è¦")
		_dialog "è¯·é—®æ˜¯å¦éœ€è¦ä½¿ç”¨å…¨å±æ¨¡å¼ï¼Ÿ" "è¯·é—®æ˜¯å¦éœ€è¦ä½¿ç”¨å…¨å±æ¨¡å¼ï¼Ÿ\nè¯·é€‰æ‹©" $OPTIONS
		case $op in
			1)
				echo "fullscreen=true" >> $HOME/.termux/termux.properties
				_msg W "å¦‚æœåœ¨ä½ çš„è®¾å¤‡ä¸Šå…¨å±æ¨¡å¼æœ‰bugï¼Œè¯·è®¿é—®wiki: https://wiki.termux.com/wiki/Terminal_Settings"
				_msg W "æˆ–è€…å–æ¶ˆå…¨å±æ¨¡å¼ï¼šæ‰“å¼€ ~/.termux/termux.properties åˆ é™¤ fullscreen=true åï¼Œä½¿ç”¨å‘½ä»¤ termux-reload-settings"
				;;
		esac
		_msg I "é…ç½®ç”Ÿæ•ˆingâ€¦â€¦ "
		_command "termux-reload-settings"
   		_msg W "è¯·ç»™termuxæƒé™ï¼"
		_enter
		_command "termux-wake-lock"
		_enter
		_command "termux-setup-storage"
		_enter
		echo -e "${GREEN} éšè—termuxåº•éƒ¨é¢å¤–é”®ï¼š ${RED}æŒ‰æ‰‹æœºéŸ³é‡é”®+ å†æŒ‰ k é”®${GREEN}ï¼ˆçœŸæ­£å…¨å±ï¼ï¼‰${WHITE}"
		echo -e "${GREEN} å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·å¤šæ‰§è¡Œå®‰è£…å‡ æ¬¡ï¼Œç¡®ä¿æ’ä»¶å…¨éƒ¨å®‰è£…å®Œæ¯•ã€‚${WHITE}"
		echo -e "${GREEN} neovim IDEå·²å‡†å¤‡å°±ç»ªï¼è¯·æ‰“å¼€å®ƒå§ã€‚${WHITE}"
		_enter;_enter
	}
	_d(){
		_msg W "ä½ ç¡®å®šè¦å¸è½½å—ï¼Ÿï¼»å›è½¦ä¸¤æ¬¡å¸è½½ï¼½"
		_enter;_enter
		_command "pkg remove" "neovim" "-y"
		_command "rm -rf" "$HOME/.config/nvim $HOME/.local/share/nvim "
		_command "rm -rf" "$HOME/.vim/dict/ultimate.db $PREFIX/opt/openjdk-11.0.12"
		_msg I "neovim IDEå¸è½½å®Œæ¯•ï¼"
		_enter
	}
	_ud(){
		[ ! -e "$HOME/.config/nvim" ] && _msg W "è¯·å…ˆå®‰è£…nvim IDEï¼" && return 0
		_msg I "æµ‹è¯•ç½‘ç»œè¿é€šæ€§â€¦â€¦"
		ping -c 3 gitee.com >/dev/null 2>&1 
		[  "$?" != "0" ] && _msg E "æ— æ³•è®¿é—®åˆ°Giteeï¼Œè¯·æ£€æŸ¥ç½‘ç»œ" && return 0
		_msg I "ç½‘ç»œè¿æ¥æˆåŠŸï¼"
		[ -z "$(command -v wget)" ] && _command "pkg i -y" "wget"
		_msg W "æ³¨æ„ï¼æ­¤æ“ä½œä¼šå¤‡ä»½åŸé…ç½®ï¼Œç„¶åæ¢ä¸Šæ–°é…ç½®é…ç½®ï¼"
		_msg W "å¹¶ä¸”è¯·ç¡®ä¿ä½ çš„ç½‘ç»œèƒ½å¤Ÿè®¿é—®åˆ° http://github.com ï¼"
		_enter
		cd $HOME/.config
		zip -r nvim.bak.zip nvim
		rm -rf nvim
		_msg W "æ‰“åŒ…æ—§é…ç½®ä¸º$HOME/.config/nvim.bak.zip"
		_enter
		_command "-raw" "wget -c" "$NVIM_ZIP_RAW"	
		_command "-raw" "wget -c" "$FONT_TAR_XZ_RAW"		
		unzip -o nvim.zip
		xz -d font.tar.xz
		tar -xvf font.tar
		mv font.ttf $HOME/.termux
		rm -rf nvim.zip font.tar
		sleep 1
		_msg I "æ›´æ¢nviméœ€è¦çš„å­—ä½“æ”¯æŒï¼ˆä¸Šç™¾æ¬¾å­—ä½“å¯ç”¨è®¿é—®ï¼šhttps://www.nerdfonts.comä¸‹è½½ï¼‰"
		_enter
		echo "extra-keys = [['ESC','/','-','HOME','UP','END','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','SHIFT']] " > $HOME/.termux/termux.properties
		_msg W "å…¨å±æ¨¡å¼ä¼šå±è”½æ‰‹æœºçŠ¶æ€æ ï¼Œå¹¶ä¸”åœ¨æŸäº›è®¾å¤‡ä¸Šæœ‰bugï¼Œä¸ä¸€å®šä¼šæˆåŠŸ"
		_enter
		
	    OPTIONS=(
         "éœ€è¦æ²‰æµ¸æ¨¡å¼"
         "ä¸éœ€è¦")
		_dialog "è¯·é—®æ˜¯å¦éœ€è¦ä½¿ç”¨å…¨å±æ¨¡å¼ï¼Ÿ" "è¯·é€‰æ‹©" $OPTIONS
		case $op in
			1)
				echo "fullscreen=true" >> $HOME/.termux/termux.properties
				_msg W "å¦‚æœåœ¨ä½ çš„è®¾å¤‡ä¸Šå…¨å±æ¨¡å¼æœ‰bugï¼Œè¯·è®¿é—®wiki: https://wiki.termux.com/wiki/Terminal_Settings"
				_msg W "æˆ–è€…å–æ¶ˆå…¨å±æ¨¡å¼ï¼šæ‰“å¼€ $HOME/.termux/termux.properties åˆ é™¤ fullscreen=true åï¼Œä½¿ç”¨å‘½ä»¤ termux-reload-settings "
				;;
		esac
		_msg I "é…ç½®ç”Ÿæ•ˆingâ€¦â€¦"
		termux-reload-settings
		echo -e "${GREEN} éšè—termuxåº•éƒ¨é¢å¤–é”®ï¼š æ‰‹æœºéŸ³é‡é”®+k ï¼ˆçœŸæ­£å…¨å±ï¼ï¼‰${WHITE}"
		echo -e "${GREEN} å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·å¤šæ‰§è¡Œå®‰è£…å‡ æ¬¡ï¼Œç¡®ä¿æ’ä»¶å…¨éƒ¨å®‰è£…å®Œæ¯•ã€‚${WHITE}"
		echo -e "${GREEN} neovim IDEå·²å‡†å¤‡å°±ç»ªï¼è¯·æ‰“å¼€å®ƒå§ã€‚${WHITE}"
		echo -e "\n${GREEN}[$(date +"%Yå¹´%mæœˆ%dæ—¥-%Hæ—¶%Måˆ†%Sç§’")]æ›´æ–°æˆåŠŸ${WHITE}"
		_enter
	}
    OPTIONS=(
         "å®‰è£…nvimIDE"
         "å¸è½½nvimIDE"
         "æ›´æ–°nvimIDEé…ç½®æ–‡ä»¶"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "nim IDE v0.5" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _d
			;;
		3)
			_node _ud
			;;
		*)
			return 0
			;;
	esac
}


_wikijs(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}Wiki.js æ˜¯ä¸€ä¸ªåŸºäº NodeJS çš„ç°ä»£ã€è½»é‡çº§å’Œå¼ºå¤§çš„ wiki åº”ç”¨ç¨‹åºã€‚è¾ƒé€‚åˆåšå°å›¢é˜Ÿçš„çŸ¥è¯†åº“ï¼Œä¸€æ–¹é¢é€‚åˆç®¡ç†å’Œé˜…è¯»ï¼Œå¦ä¸€æ–¹é¢è¿˜èƒ½ååŒåˆ›ä½œã€‚
			${GREEN}Githubï¼š${WHITE}https://github.com/requarks/wiki
			${GREEN}ä½¿ç”¨è¯´æ˜ä¹¦ï¼š${WHITE}https://docs.requarks.io/install/requirements
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t${GREEN}æ•°æ®åº“(ä»¥ä¸‹å…¶ä¸€)ï¼š${WHITE}
			\t\tâ—MySQL â‰¥8.0
			\t\tâ—MariaDB â‰¥10.2.7
			\t\tâ—SQLite â‰¥3.9
			\t\tâ—MS SQL Server â‰¥2012  (ä»…ä¾›å‚è€ƒ)
			\t${GREEN}Node.jsï¼š${WHITE}
			\t\tâ— 16.0.0â‰¤ node <17.0.0  (æ¨è)
			EOF
		)"
		_checkInstall "$PREFIX/opt/wiki" && rm -rf "$PREFIX/var/service/wiki" || return 0
		 _command "apt purge nodejs-16 -y"
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		
		# install wiki.js
		mkdir -p "$PREFIX/opt/wiki"
		cd "$PREFIX/opt/wiki"
		_command "-release" "wget -c" "$WIKIJS_RELEASE"
		tar -zxvf wiki-js.tar.gz
		rm -rf wiki-js.tar.gz
		
		# install nodejs-16
		_command "pkg i" "openssl-1.1 c-ares libicu" "-y"
		cd $PREFIX/opt/
		rm -rf nodejs-16*
		_command "-raw" "wget -c" "$NODEJS16_RAW"
		dpkg -i nodejs-16.19.1-aarch64.deb
		rm -rf ./nodejs-16.19.1-aarch64.deb
	    # é€‰æ‹©æ•°æ®åº“
	    OPTIONS=(
			"MySQLï½œlocalhost:3306"
			"MariaDBï½œlocalhost:3306"
			"sqliteï½œlocalhost:3306")
		_dialog "æ•°æ®åº“é€‰æ‹©" "è¯·é€‰æ‹©æ•°æ®åº“ä¿¡æ¯" $OPTIONS
		
		# æš‚ä¸”å›ºå®šä¸ºMySQL
		op=1
		# MySQL
		if [ "$op" == "1" ];then
			password=""
			while :
			do
				password=$(dialog --clear --title "è¯·è¾“å…¥MySQL ç”¨æˆ·rootçš„å¯†ç " \
				--inputbox "è¾“å…¥rootçš„å¯†ç ï¼š" 8 50 \
				3>&1 1>&2 2>&3 3>&-)
				
				clear
				mysql -uroot -p${password} -e "drop database if exists wiki;"
				mysql -uroot -p${password} -e "create database if not exists wiki;show databases;"
				if [ "$?" == "0" ];then
					mysql -uroot -p${password} -e "CREATE USER  if not exists 'wikijs'@'localhost' IDENTIFIED BY '${password}';"
					mysql -uroot -p${password} -e "GRANT ALL ON wiki.* TO 'wikijs'@'localhost';"
					_msg W "æˆåŠŸåˆ›å»ºwikiæ•°æ®åº“ï¼"
					_msg W "Userï¼šwikijs  Passwordï¼š${password}"
					_enter
					break
				else
					_msg E "åˆ›å»ºwikiæ•°æ®åº“å¤±è´¥ï¼è¯·æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åœ¨è¿è¡Œ æˆ– å¯†ç æ˜¯å¦æ­£ç¡®"
					_enter
				fi
			done
			# é…ç½®wiki.jsæ–‡ä»¶
			cd $PREFIX/opt/wiki
			cp config.sample.yml config.yml
			sed -i "s#type: postgres#type: mysql#g;s#port: 5432#port: 3306#g;s#user: wikijs#user: wikijs#g;s#pass: wikijsrocks#pass: ${password}#g" config.yml
		# MariaDB
		elif [ "$op" == "2" ];then
			echo
		# sqlite
		elif [ "$op" == "3" ];then
			echo
		fi
		_msg I "wiki.jså®‰è£…æˆåŠŸï¼"
		_enter
	}
	_start(){
		clear
		[ ! -e "$PREFIX/opt/wiki"  ] && _msg E "è¯·å…ˆå®‰è£…wiki.jsï¼" && _enter && return 0
		path="$PREFIX/var/service/wiki"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			sleep 10
			cd "$PREFIX/opt/wiki"
			exec $PREFIX/opt/nodejs-16/bin/node server
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
	    # é€‰æ‹©æ•°æ®åº“
	    OPTIONS=(
			"MySQLï½œlocalhost:3306"
			"MariaDBï½œlocalhost:3306"
			"sqliteï½œlocalhost:3306")
		_dialog "æ•°æ®åº“é€‰æ‹©" "è¯·é€‰æ‹©æ•°æ®åº“ä¿¡æ¯" $OPTIONS
		case "$op" in
		1)
			_command "sv-enable mysqld"
			;;
		2)
			_command "sv-enable mariadbd"
			;;
		3)
			_command "sv-enable sqlite"
			;;
		esac		
		_command "sv-enable wiki"
		_msg W "ç½‘ç«™åœ°å€ï¼šlocalhost:3000"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter
	}
	_stop(){
		clear
		[ ! -e "$PREFIX/opt/wiki"  ] && _msg E "è¯·å…ˆå®‰è£…wiki.jsï¼" && _enter && return 0
		_command "sv-disable wiki"
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½Wiki.js"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’Wiki.js" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

_wordpress(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}WordPressæ˜¯ä¸€æ¬¾ä¸ªäººåšå®¢ç³»ç»Ÿï¼Œå¹¶é€æ­¥æ¼”åŒ–æˆä¸€æ¬¾å†…å®¹ç®¡ç†ç³»ç»Ÿ
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://cn.wordpress.org
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t\tâ—MySQL
			\t\tâ—PHP
			\t\tâ—php-fpm
			\t\tâ—nginx
			EOF
		)"
		_checkInstall "$PREFIX/opt/wordpress" && rm -rf $PREFIX/etc/nginx/config/wordpress.conf || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		[ -z "$(command -v php)" ] && _command "pkg i -y" "php"
		[ -z "$(command -v php-fpm)" ] && _command "pkg i -y" "php-fpm"
		[ -z "$(command -v nginx)" ] && _command "pkg i -y" "nginx"
		# install wordpress
		cd "$PREFIX/opt/"
		_command "wget -c" "$WORDPRESS" "-O wordpress.zip"
		unzip wordpress.zip
		rm -rf wordpress.zip
		
		# MySQL
		password=""
		while :
		do
			password=$(dialog --clear --title "è¯·è¾“å…¥MySQL ç”¨æˆ·rootçš„å¯†ç " \
			--inputbox "è¾“å…¥rootçš„å¯†ç ï¼š" 8 50 \
			3>&1 1>&2 2>&3 3>&-)
			
			clear
			mysql -uroot -p$password -e "create database if not exists wordpress;show databases;"
			if [ "$?" == "0" ];then
				mysql -uroot -p${password} -e "CREATE USER  if not exists 'wordpress'@'localhost' IDENTIFIED BY '${password}';"
				mysql -uroot -p${password} -e "GRANT ALL ON wordpress.* TO 'wordpress'@'localhost';"
				_msg W "æˆåŠŸåˆ›å»ºwordpressæ•°æ®åº“ï¼"
				_msg W "Userï¼šwordpress  Passwordï¼š${password}"
				_enter
				break
			else
				_msg E "åˆ›å»ºwordpressæ•°æ®åº“å¤±è´¥ï¼è¯·æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åœ¨è¿è¡Œ æˆ– å¯†ç æ˜¯å¦æ­£ç¡®"
				_enter
			fi
		done
		
		# wordpressé…ç½®
		cd $PREFIX/opt/wordpress
		cp wp-config-sample.php wp-config.php
		file=$PREFIX/opt/wordpress/wp-config.php
		sed -i "s#database_name_here#wordpress#g" $file
		sed -i "s#username_here#wordpress#g" $file
		sed -i "s#password_here#${password}#g" $file
		sed -i "s#localhost#127.0.0.1#g" $file
		
		# nginxé…ç½®
		file="$PREFIX/etc/nginx/nginx.conf"
		if [ -z "$(cat $file | grep 'include config/*.conf;')" ];then
			row=$(cat $file |grep -n } | sed -n 12p | awk -F ":" '{print $1}')
			sed -i "$(($row-1))i include config/*.conf;" $file
		fi
		mkdir -p $PREFIX/etc/nginx/config
		cat<<-EOF> $PREFIX/etc/nginx/config/wordpress.conf
			server {
			    listen       8010;
			    #listen       [::]:80;			ipv6
			    server_name  127.0.0.1;
			    location / {
			        root   $PREFIX/opt/wordpress;		# æœåŠ¡1çš„å‰ç«¯æ–‡ä»¶å­˜æ”¾çš„åœ°å€
			        index  index.php index.html index.htm;									# æŒ‡å®šé»˜è®¤è®¿é—®çš„é¡µé¢
			    }
			    location ~ .php/$ {
			    root  $PREFIX/opt/wordpress;
			    index  index.php index.html index.htm;
			    fastcgi_pass   unix:$PREFIX/var/run/php-fpm.sock;
			    fastcgi_index  index.php;
			    fastcgi_param  SCRIPT_FILENAME  \$document_root\$fastcgi_script_name;
			    include  fastcgi_params;
		        }
		    }
		EOF
		_msg I "wordpresså®‰è£…æˆåŠŸï¼"
		_enter		
	}
	_start(){
		clear
		[ ! -e "$PREFIX/opt/wordpress" ] && _msg E "è¯·å…ˆå®‰è£…wordpressï¼" && _enter && return 0
		_command "sv-enable mysqld"
		_command "sv-enable php-fpm"
		_command "sv-enable nginx"
		_msg W "ç½‘ç«™åœ°å€ï¼šlocalhost:8010"
		_enter
	}
	_stop(){
		clear
		[ ! -e "$PREFIX/opt/wordpress" ] && _msg E "è¯·å…ˆå®‰è£…wordpressï¼" && _enter && return 0
		_command "sv-disable php-fpm"
		_command "sv-disable nginx"
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½wordpress"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’wordpress" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

_phpMyAdmin(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}phpMyAdmin æ˜¯ç”± PHP ç¼–å†™çš„ç”¨äºç®¡ç† MySQL æˆ– MariaDB ç­‰æ•°æ®æœåŠ¡å™¨çš„å…è´¹è½¯ä»¶å·¥å…·
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://www.phpmyadmin.net
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t\tâ—MySQL
			\t\tâ—PHP
			\t\tâ—php-fpm
			\t\tâ—nginx
			EOF
		)"
		_checkInstall "$PREFIX/opt/phpMyAdmin" && rm -rf $PREFIX/etc/nginx/config/phpMyAdmin.conf || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		[ -z "$(command -v php)" ] && _command "pkg i -y" "php"
		[ -z "$(command -v php-fpm)" ] && _command "pkg i -y" "php-fpm"
		[ -z "$(command -v nginx)" ] && _command "pkg i -y" "nginx"
		# install phpMyAdmin
		cd "$PREFIX/opt/"
		_command "wget -c" " https://files.phpmyadmin.net/phpMyAdmin/5.2.1/phpMyAdmin-5.2.1-all-languages.zip" " -O phpMyAdmin.zip"
		unzip phpMyAdmin.zip
		mv phpMyAdmin-* phpMyAdmin
		rm -rf phpMyAdmin.zip
		cd phpMyAdmin
		cp config.sample.inc.php config.inc.php
		sed -i "s#localhost#127.0.0.1#g" config.inc.php
		
		# nginxé…ç½®
		file="$PREFIX/etc/nginx/nginx.conf"
		if [ -z "$(cat $file | grep 'include config/\*.conf;')" ];then
			row=$(cat $file |grep -n } | sed -n 12p | awk -F ":" '{print $1}')
			sed -i "$(($row-1))i include config/*.conf;" $file
		fi
		mkdir -p $PREFIX/etc/nginx/config
		cat<<-EOF> $PREFIX/etc/nginx/config/phpMyAdmin.conf
			server {
			    listen       8020;
			    #listen       [::]:80;			ipv6
			    server_name  127.0.0.1;
			    location / {
			        root   $PREFIX/opt/phpMyAdmin;		# æœåŠ¡1çš„å‰ç«¯æ–‡ä»¶å­˜æ”¾çš„åœ°å€
			        index  index.php index.html index.htm;									# æŒ‡å®šé»˜è®¤è®¿é—®çš„é¡µé¢
			    }
			    location ~ .php$ {
			    root  $PREFIX/opt/phpMyAdmin;
			    index  index.php index.html index.htm;
			    fastcgi_pass   unix:$PREFIX/var/run/php-fpm.sock;
			    fastcgi_index  index.php;
			    fastcgi_param  SCRIPT_FILENAME  \$document_root\$fastcgi_script_name;
			    include  fastcgi_params;
		        }
		    }
		EOF

		_msg I "phpMyAdminå®‰è£…æˆåŠŸï¼"
		_enter
	}
	_start(){
		clear
		[ ! -e "$PREFIX/opt/phpMyAdmin" ] && _msg E "è¯·å…ˆå®‰è£…phpMyAdminï¼" && _enter && return 0
		_command "sv-enable mysqld"
		_command "sv-enable php-fpm"
		_command "sv-enable nginx"
		_msg W "ç½‘ç«™åœ°å€ï¼šlocalhost:8020"
		_enter
	}
	_stop(){
		clear
		[ ! -e "$PREFIX/opt/phpMyAdmin" ] && _msg E "è¯·å…ˆå®‰è£…phpMyAdminï¼" && _enter && return 0
		_command "sv-disable php-fpm"
		_command "sv-disable nginx"
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½phpMyAdmin"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’phpMyAdmin" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

_TreeSoft(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}TreeSoftæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯ä½¿ç”¨javaå¼€å‘çš„ï¼Œå¯ä»¥å¸ƒç½²äºwindow,linux,macç­‰æ“ä½œç³»ç»Ÿã€‚é‡‡ç”¨webæ–¹å¼ç®¡ç†æ•°æ®åº“ï¼Œä¸€æ¬¡å¸ƒç½²ï¼Œåˆ°å¤„ä½¿ç”¨ï¼åŒæ—¶æ”¯æŒ MySQLï¼ŒOracleï¼ŒDB2ï¼ŒPostgreSQLï¼ŒSQL Serverï¼ŒmongoDBï¼ŒHiveï¼ŒSAP HANAï¼ŒSybaseï¼ŒCachÃ© ï¼Œè¾¾æ¢¦DM7ï¼Œç¥é€šç­‰å¼‚æ„æ•°æ®åº“ã€‚
			${GREEN}å®˜ç½‘ï¼š${WHITE}http://www.treesoft.cn/dms.html
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t\tâ—jdk-1.8åŠä»¥ä¸Šï¼ˆè„šæœ¬é»˜è®¤ä½¿ç”¨openjdk-17ï¼‰
			\t\tâ—tomcat 9.0.0åŠä»¥ä¸Š
			EOF
		)"
		# install TreeSoft
		_checkInstall "$PREFIX/opt/tomcat" && _command "pkill -9 java" && rm -rf "$PREFIX/var/service/tomcat" || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0

		[ -z "$(command -v java)" ] && _command "pkg i -y" "openjdk-17"
		cd "$PREFIX/opt/"
		_command "-release" "wget -c" "$TOMCAT_RELEASE"
		unzip tomcat.zip
		rm -rf tomcat.zip
		chmod 775 $PREFIX/opt/tomcat/bin/catalina.sh
		chmod 775 $PREFIX/opt/tomcat/bin/startup.sh
		chmod 775 $PREFIX/opt/tomcat/bin/shutdown.sh
		_msg I "TreeSoftå®‰è£…æˆåŠŸï¼"
		_enter
	}
	_start(){
		clear
		[ ! -e "$PREFIX/opt/tomcat"  ] && _msg E "è¯·å…ˆå®‰è£…TreeSoftï¼" && _enter && return 0
		path="$PREFIX/var/service/tomcat"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			if [ -z "\$(ps -ef | grep tomcat/ | grep -v grep)" ];then
			    exec $PREFIX/opt/tomcat/bin/startup.sh
			    read op
			fi
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable tomcat"
		_msg W "ç½‘ç«™åœ°å€ï¼šlocalhost:8085/treesoft"
		_msg I "ç”¨æˆ·åï¼šadmin"
		_msg I "åœ°å€ï¼štreesoft"
		_msg I "éªŒè¯ç ï¼šéšä¾¿å¡«ï¼ï¼"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter
	}
	_stop(){
		clear
		[ ! -e "$PREFIX/opt/tomcat"  ] && _msg E "è¯·å…ˆå®‰è£…TreeSoftï¼" && _enter && return 0
		_command "sv-disable tomcat"
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½TreeSoft"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’TreeSoft" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

_mmcd(){
		##æ‰€æœ‰è®¾å¤‡çš„ç¼–ç 
		AllNum=(
		##
		"6381715522"
		"6381711269"
		"6381706707"
		"6384409797"
		"6384409896"
		"6381706728"
		##
		"6381706745"
		"6280501937"
		"6380500473"
		"6280501923"
		"6381701046"
		"6384409885"
		##
		"6380603292"
		"6380606290"
		"6380606289"
		"6380603243"
		"6280500021"
		"6380601933"
		"6380603266"
		##
		"6380603240"
		"6380602642"
		"6380602601"
		"6380606238"
		"6380500943"
		"6380500992"
		"6380500951"
		##
		"6381711270"
		"6381711273"
		)
		##å¯¹åº”ç¼–ç ä¿¡æ¯
		Message=(
		##
		"DåŒºå®¿èˆå‰é¢æ–œå¡A[ç¦»DåŒºæœ€è¿œ]"
		"DåŒºå®¿èˆå‰é¢æ–œå¡B"
		"DåŒºå®¿èˆå‰é¢æ–œå¡C"
		"DåŒºå®¿èˆå‰é¢æ–œå¡D"
		"DåŒºå®¿èˆå‰é¢æ–œå¡E"
		"DåŒºå®¿èˆå‰é¢æ–œå¡F[ç¦»DåŒºæœ€è¿‘]"
		##
		"FåŒºå®¿èˆå‰é¢A[ç¦»å²—é—¨æœ€è¿œ]"
		"FåŒºå®¿èˆå‰é¢B"
		"FåŒºå®¿èˆå‰é¢C"
		"FåŒºå®¿èˆå‰é¢D"
		"FåŒºå®¿èˆå‰é¢E"
		"FåŒºå®¿èˆå‰é¢F[ç¦»å²—é—¨æœ€è¿‘]"
		##
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šA[ç¦»ä¸­å¤®é£Ÿå ‚æœ€è¿‘]"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šB"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šC"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šD"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šE"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šF"
		"BåŒºå®¿èˆ[å·¦ä¾§]å……ç”µè½¦æ£šG[BåŒºå®¿èˆå·¦é—¨å£]"
		##
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šA[BåŒºå®¿èˆå³é—¨å£]"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šB"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šC"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šD"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šE"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šF"
		"BåŒºå®¿èˆ[å³ä¾§]å……ç”µè½¦æ£šG[ç¦»ä¸­å¤®é£Ÿå ‚æœ€è¿œ]"
		##
		"ç´«è†åºœ"
		"æ³°é¡ºå¿é¦™æ´²é›…è‹‘2018.10.18LA"
		)

		# Login headers
		Login=(
		"appVersion: 2.7.2"
		"client: android"
		"client-osVersion: 30"
		#"deviceId: CC652F2E899531A5C38DB6BEF39F750F"
		#"appId: 20171108"
		#"timestamp: 1646839690092"
		#"signature: dcb065d6b51d25f13dd8fc9ced7b3283"
		"appCommId: MCB_INSTANCE_ANDROID_APP"
		"Content-Type: application/json; charset=utf-8"
		#"Content-Length: 57"
		#"Content-Length: 62"
		#"Content-Length: 30"
		"Host: mobile.mamcharge.com"
		"Connection: Keep-Alive"
		#"Accept-Encoding: gzip"
		"User-Agent: okhttp/3.2.0"
		)

	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}å£°æ˜ï¼š${WHITE}
			\t\tâ—ä»…æä¾›å­¦ä¹ æµ‹è¯•ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”ï¼
			\t\tâ—ä»…æä¾›å­¦ä¹ æµ‹è¯•ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”ï¼
			\t\tâ—ä»…æä¾›å­¦ä¹ æµ‹è¯•ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”ï¼
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t\tâ—MySQL
			EOF
		)"
		# install mmcd
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		[ -z "$(command -v java)" ] && _command "pkg i -y" "openjdk-17"
		[ -z "$(command -v jq)" ] && _command "pkg i -y" "jq"
		[ -z "`command -v qrencode`" ] && _command "pkg i -y" "libqrencode"
		# MySQL
		password=""
		while :
		do
			password=$(dialog --clear --title "è¯·è¾“å…¥MySQL ç”¨æˆ·rootçš„å¯†ç " \
			--inputbox "è¾“å…¥rootçš„å¯†ç ï¼š" 8 50 \
			3>&1 1>&2 2>&3 3>&-)
			
			clear
			mysql -uroot -p${password} -e "drop database if exists mmcd;"
			mysql -uroot -p${password} -e "create database if not exists mmcd;show databases;"
			_enter
			if [ "$?" == "0" ];then
				# è·å–æ‰‹æœºå·
				phone=$(dialog --clear --title "è¯·è¾“å…¥ä½ çš„æ‰‹æœºå·ç " \
				--inputbox "å…±11ä½" 8 50 \
				3>&1 1>&2 2>&3 3>&-)
				random=("A" "B" "C" "D" "E" "F")
				A1=${random[$[$RANDOM%6]]} ; A2=${random[$[$RANDOM%6]]} ; A3=${random[$[$RANDOM%6]]} ; A4=${random[$[$RANDOM%6]]} ; N1=$[$RANDOM%10] ; N2=$[$RANDOM%10] ; N3=$[$RANDOM%10] ; N4=$[$RANDOM%10]
				device="${A1}${A2}652F2E${N1}99${N2}31A5C38${A3}B6B${A4}F3${N3}F75${N4}F"
				appid=20171108
				
				# åˆ›å»ºç”¨æˆ·
				mysql -uroot -p${password} -e "CREATE USER  if not exists 'mmcd'@'localhost' IDENTIFIED BY '123456';"
				mysql -uroot -p${password} -e "GRANT ALL ON mmcd.* TO 'mmcd'@'localhost';"
				
				# å……ç”µæ¡©ä¿¡æ¯
				mysql -uroot -p${password} -e "use mmcd;create table if not exists msg(sno int(5), coding bigint(50), name varchar(100));"
				# å½•å…¥å……ç”µæ¡©ä¿¡æ¯
				for x in $(seq 0 $((${#AllNum[@]}-1)))
				do
					mysql -ummcd -p123456 -e "use mmcd; insert into msg values($(($x+1)), ${AllNum[$x]}, \"${Message[$x]}\");"
				done

				# Login 
				mysql -uroot -p${password} -e "use mmcd;create table if not exists login(sno int(5),header varchar(200));"
				# å½•å…¥è¯·æ±‚å¤´
				for x in $(seq 0 $((${#Login[@]}-1)))
				do
					mysql -ummcd -p123456 -e "use mmcd; insert into login values($(($x+1)),'${Login[$x]}');"
				done

				# ç”¨æˆ·ä¿¡æ¯
				mysql -uroot -p${password} -e "use mmcd;create table if not exists user(phone bigint(50), dev varchar(200), appid bigint(50), AppletUser varchar(200));"
				cd "$HOME/.config/td/"
				if [ ! -e "HMacMd5Utils.java" ];then
					_command "-raw" "wget -c" "$HMacMd5Utils_RAW"
				fi
				# Login è·å–cookie
				url="mobile.mamcharge.com/applet/api/applet/sendSMSCaptcha"
				data="{\"nationalCode\":\"86\",\"phoneNum\":\"${phone}\",\"type\":\"1\"}"
				javac HMacMd5Utils.java
				s=$(java HMacMd5Utils $phone)
				timestamp=$(echo $s | awk '{print $1}')
				signature=$(echo $s | awk '{print $2}')
				# Content-Length=57
				H=()
				n=$(mysql -N -uroot -p${password} -e "use mmcd; select count(*) from login;")
				for x in $(seq 0 $(($n-1)))
				do
					H[$x]="$(mysql -N -uroot -p${password} -e "use mmcd; select header from login limit $x,1;")"
				done
				_msg W "è¯·æ±‚éªŒè¯ç "
				curl -H "${H[0]}" -H "${H[1]}" -H "${H[2]}" -H "deviceId: $deviceId" -H "appId: $appid" -H "${H[3]}" -H "${H[4]}" -H "${H[5]}" -H "timestamp: $timestamp" -H "signature: $signature" -H "${H[6]}" -H "${H[7]}" -H "${H[8]}" -H "Content-Length: 57" -H "${H[10]}" -H "${H[11]}" -H "${H[12]}" -H "${H[13]}" -H "${H[14]}" -H "${H[15]}" -X POST -d "$data" $url
				AuthCode=$(dialog --clear --title "è¯·è¾“å…¥éªŒè¯ç " \
				--inputbox "æ³¨æ„æŸ¥æ”¶" 8 50 \
				3>&1 1>&2 2>&3 3>&-)
				AuthCode=$(echo $AuthCode | sed "s# ##g")
				# è·å–cookie
				url="mobile.mamcharge.com/applet/api/applet/loginOrRegister"
				data="{\"code\":\"$AuthCode\",\"nationalCode\":\"86\",\"phoneNum\":\"$phone\"}"
				javac HMacMd5Utils.java
				s=$(java HMacMd5Utils $phone $AuthCode)
				timestamp=$(echo $s | awk '{print $1}')
				signature=$(echo $s | awk '{print $2}')
				_msg W "è·å–cookie"
				curl -H "${H[0]}" -H "${H[1]}" -H "${H[2]}" -H "deviceId: $deviceId" -H "appId: $appid" -H "${H[3]}" -H "${H[4]}" -H "${H[5]}" -H "timestamp: $timestamp" -H "signature: $signature" -H "${H[6]}" -H "${H[7]}" -H "${H[8]}" -H "Content-Length: 62" -H "${H[10]}" -H "${H[11]}" -H "${H[12]}" -H "${H[13]}" -H "${H[14]}" -H "${H[15]}" -X POST -d "$data" $url > ./cookie
				# token
				AppletUser=$(jq -r .data.token cookie)
				# ä¿å­˜ç”¨æˆ·ä¿¡æ¯
				mysql -uroot -p${password} -e "use mmcd; insert into user values(${phone}, \"${device}\", $appid, \"$AppletUser\");"
				break
			else
				_msg E "åˆ›å»ºmmcdæ•°æ®åº“å¤±è´¥ï¼è¯·æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åœ¨è¿è¡Œ æˆ– å¯†ç æ˜¯å¦æ­£ç¡®"
				_enter
			fi
		done
		_msg W "ç”¨æˆ·ä¿¡æ¯"
		mysql -ummcd -p123456 -e "use mmcd; select * from user;"
		_msg W "å……ç”µæ¡©ä¿¡æ¯"
		mysql -ummcd -p123456 -e "use mmcd; select * from msg;"
		_msg W "è¯·æ±‚å¤´ä¿¡æ¯"
		mysql -ummcd -p123456 -e "use mmcd; select * from login;"

		
		_msg I "çŒ›çŠ¸å……ç”µé…ç½®æˆåŠŸï¼"
		_enter
	}
	
	_check(){
		clear
		mysql -ummcd -p123456 -e "use mmcd; select count(*) from msg;" > /dev/null
		[ ! "$?" == "0" ] && _msg E "è¯·å…ˆé…ç½®çŒ›çŠ¸å……ç”µ" && _enter && return 0
		n=$(mysql -N -ummcd -p123456 -e "use mmcd; select count(*) from msg;")
		[ ! $n -gt 1 ] &&  _msg E "è¯·å…ˆé…ç½®çŒ›çŠ¸å……ç”µ" && _enter && return 0
		
		mkdir -p $HOME/.cache/td
		tmp=$HOME/.cache/td/status.json
		# download HMacMd5Utils.java
		cd $HOME/.config/td
		if [ ! -e "$HOME/.config/td/HMacMd5Utils.java" ];then
			_command "-raw" "wget -c" "$HMacMd5Utils_RAW"
		fi
		# è¯·æ±‚å¤´å‚æ•°
		phone=$(mysql -N -ummcd -p123456 -e "use mmcd; select phone from user;")
		deviceId=$(mysql -N -ummcd -p123456 -e "use mmcd; select dev from user;")
		appid=$(mysql -N -ummcd -p123456 -e "use mmcd; select appid from user;")
		url="mobile.mamcharge.com/applet/api/startCharger/deviceDetail"	
		AppletUser=$(mysql -N -ummcd -p123456 -e "use mmcd; select AppletUser from user;")
		Token="token: $AppletUser"
		n=$(mysql -N -ummcd -p123456 -e "use mmcd; select count(*) from login;")
		for x in $(seq 0 $(($n-1)))
		do
			H[$x]="$(mysql -N -ummcd -p123456 -e "use mmcd; select header from login limit $x,1;")"
		done
		
		mysql -ummcd -p123456 -e "use mmcd; select * from msg;"
		echo -e "$(
		cat<<-EOF
		${YELLOW}è¾“å…¥è¯´æ˜${WHITE}
		\tâ—æŸ¥è¯¢å•ä¸ªå……ç”µæ¡©ï¼š6
		\tâ—æŸ¥è¯¢å¤šä¸ªå……ç”µæ¡©ï¼š6 9 20 15
		\tâ—æŸ¥è¯¢å¤šä¸ªä¸”è¿ç»­çš„å……ç”µæ¡©ï¼š5-16
		EOF
		)"
		echo -en "${YELLOW}è¾“å…¥è¦æŸ¥è¯¢çš„å……ç”µæ¡©(sno)ï¼š${GREEN}"
		read op
		if [ "$op" == "" ];then
			echo -e "\n${RED}ä½ æ²¡æœ‰è¾“å…¥æ•°å€¼ï¼${WHITE}"
			_enter
			return 0
		fi
		# å……ç”µæ¡©çš„æ€»æ•°
		n=$(mysql -N -ummcd -p123456 -e "use mmcd; select count(*) from msg;")
		# åˆ¤æ–­æ˜¯å¦æ˜¯1-9è¿™ç±»è¾“å…¥
		if [[ "$(echo "$op" | grep "-" )" != "" ]];then
			first=$(echo "$op" | grep "-" | awk -F "-" '{print $1}')
			second=$(echo "$op" | grep "-" | awk -F "-" '{print $2}')
			if [ -z "$first" ] || [ -z "$second" ] || [ $first -gt $second ];then
				_msg E "ä½ çš„è¾“å…¥æœ‰è¯¯ï¼"
				_enter
				return 0
			fi
			op="$(seq $(echo "$op" | sed "s#-# #g"))"
		fi
		echo $op
		#1 3 6 10 79
		##åˆ¤æ–­åºå·æ˜¯å¦è¶…å‡ºèŒƒå›´
		for x in $op
		do
			##åˆ¤æ–­è¾“å…¥æ˜¯å¦åˆæ³•ï¼Œæ˜¯ä¸º0
			expr $x + 10 > /dev/null 2>&1
			if [ "$?" -eq "2" ] || [  "$x" -lt "1" ] || [  "$x" -gt "$n" ];then
				_msg E "ä½ çš„è¾“å…¥æœ‰è¯¯ï¼æˆ–è¶…å‡ºèŒƒå›´ï¼"
				_enter
				return 0
			fi
		done
		
		# å¼€å§‹æŸ¥è¯¢
		echo -e "\n${BLUE}è¯·è€å¿ƒç­‰å¾…â€¦${WHITE}"
		for x in $op
		do
			# è¯·æ±‚å¤´ä¿¡æ¯
			x=$(($x-1))
			coding=$(mysql -N -ummcd -p123456 -e "use mmcd; select coding from msg limit $x,1;")
			name=$(mysql -N -ummcd -p123456 -e "use mmcd; select name from msg limit $x,1;")
			data="{\"pno\":\"$coding\"}"
			javac HMacMd5Utils.java
			s=$(java HMacMd5Utils $coding 1 2)
			timestamp=$(echo $s | awk '{print $1}')
			signature=$(echo $s | awk '{print $2}')
			# è¯·æ±‚
			curl -s -H "$Token" -H "${H[0]}" -H "${H[1]}" -H "${H[2]}" -H "deviceId: $deviceId" -H "appId: $appid" -H "timestamp: $timestamp" -H "signature: $signature" -H "${H[3]}" -H "${H[4]}"  -H "Content-Length: 20" -H "${H[5]}" -H "${H[6]}" -H "${H[7]}" -H "${H[8]}" -H "${H[10]}" -H "${H[11]}" -X POST -d "$data" $url > $tmp
			# æ‰“å°
			echo -e "\t-------------${name}-------------"
			echo -e "\t\t${GREEN}å……ç”µæ¡©ç¼–ç ï¼š ${coding}${WHITE}"
			for y in $(seq 0 11)
			do
				if [ "$(jq -r .data.portList[$y].status $tmp)" == "0" ];then
					echo -e "ç¬¬$(($y+1))å·æ’å¤´ï¼š${RED}ç©ºé—²${WHITE}"
				else
					echo -e "ç¬¬$(($y+1))å·æ’å¤´ï¼šä½¿ç”¨ä¸­"
				fi
			done
		done
		_enter
	}
	##è¿œç¨‹å……ç”µ
	_remote_power(){
		clear
		mysql -ummcd -p123456 -e "use mmcd; select count(*) from msg;" > /dev/null
		[ ! "$?" == "0" ] && _msg E "è¯·å…ˆé…ç½®çŒ›çŠ¸å……ç”µ" && _enter && return 0
		n=$(mysql -N -ummcd -p123456 -e "use mmcd; select count(*) from msg;")
		[ ! $n -gt 1 ] &&  _msg E "è¯·å…ˆé…ç½®çŒ›çŠ¸å……ç”µ" && _enter && return 0
		
		mysql -ummcd -p123456 -e "use mmcd; select * from msg;"
		echo -ne "\n\n${YELLOW}è¯·è¾“å…¥å……ç”µæ¡©çš„ç¼–ç ï¼š${GREEN}"
		read op
		op=$(echo $op | sed "s# ##g")
		status=1
		for x in $(echo $(mysql -N -ummcd -p123456 -e "use mmcd; select coding from msg;"))
		do
			if [ "$op" == "$x" ];then
				status=0
				break
			fi
		done
		if [ "$status" == "0" ];then
			echo -e "\n${GREEN}é»˜è®¤è·³è½¬æ”¯ä»˜å®ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œè¯·ä½¿ç”¨å¾®ä¿¡ / QQ / äº‘é—ªä»˜ç­‰ç­‰æ‰«ç ${WHITE}"
			am start -a android.intent.action.VIEW -d "alipays://platformapi/startapp?appId=20000067&url=www.chargerlink.com/alicp/$op"  >/dev/null 2>&1
			qrencode -l M -t UTF8 -k "http://www.chargerlink.com/alicp/$op"
		else
			echo -e "${RED}æ­¤è„šæœ¬æ²¡æœ‰æ”¶å½•æœ‰ç¼–ç ä¸ºï¼š$opçš„å……ç”µæ¡©ï¼è¯·æ£€æŸ¥å†è¾“å…¥${WHITE}"
		fi
		_enter
		return 0
	}


  	  OPTIONS=(
	         "é…ç½®çŒ›çŠ¸å……ç”µ"
	         "æŸ¥è¯¢"
	         "è¿œç¨‹å……ç”µ"
	         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
	   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’çŒ›çŠ¸å……ç”µ" "è¯·é€‰æ‹©" $OPTIONS
	    case $op in
	   		1)
	   			_node _i
	   			;;
			2)
				_node _check
				;;
			3)
				_node _remote_power
				;;
			*)
				return 0
				;;
		esac
	}

_sql(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}è¯´æ˜ï¼š${WHITE}å³å°†å®‰è£…çš„æ•°æ®åº“æœ‰mysqlï¼Œmariadbï¼Œsqlite
			EOF
		)"
		# install SQL
		if [ -n "$(dpkg -l | grep mysql)" ] || [ -n "$(dpkg -l | grep sqlite)" ];then
			_msg W "æœ¬åœ°å·²å®‰è£…æœ‰æ•°æ®åº“"
			echo -en "${RED}æ˜¯å¦å¸è½½ï¼Ÿ[Y/N]${WHITE}" ""
			read op
			case $op in
			y|Y)
				_command "pkill mysqld"
				_command "apt purge" "mariadb sqlite" "-y"
				;;
			*)
				return 0
				;;
			esac
		fi
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		yes | pkg update
		_command "pkg i -y" "mariadb sqlite"
		sleep 2
		##é…ç½®æ•°æ®åº“
		_command "mysql_install_db --force"
		_msg I "å®‰è£…å®Œæˆï¼å›è½¦ä¼šé‡å¯ï½\né‡å¯åå†å¯åŠ¨MySQLæœåŠ¡ï¼"
		_enter
		pkill -9 $(echo $SHELL | awk -F "/" '{print $NF}')
	}
	_start(){
		clear
		[ -z "$(dpkg -l | grep mysql)"  ] && _msg E "è¯·å…ˆå®‰è£…æ•°æ®åº“ï¼" && _enter && return 0
		_command "sv-enable mysqld"
		_msg W "MySQLå®‰è£…åé»˜è®¤æ— å¯†ç \nåˆå§‹å¯†ç å‘½ä»¤ä¸ºï¼šmysqladmin -u root password 123456"
		_msg W "MySQLï¼šlocalhost:3306"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter
	}
	_stop(){
		clear
		[ -z "$(dpkg -l | grep mysql)"  ] && _msg E "è¯·å…ˆå®‰è£…æ•°æ®åº“ï¼" && _enter && return 0
		_command "sv-disable mysqld"
		_msg W "æ—¥å¿—ï¼š$PREFIX/var/log/sv/"
		_enter	
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½æ•°æ®åº“mysql,mariadb,sqlite"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’æ•°æ®åº“" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _start
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}


_speed(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}ä¸€æ¬¾ç®€å•çš„ç½‘é€Ÿæµ‹è¯•
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://github.com/sivel/speedtest-cli
			EOF
		)"
		# install SpeedTest
		runfile=$PREFIX/bin/speedtest-cli
		[ -z "$(command -v python)" ] && _command "pkg i -y" "python"
		if [ -e "$runfile" ];then
			_msg W "æœ¬åœ°å·²å®‰è£…SpeedTest"
			echo -en "${RED}æ˜¯å¦å¸è½½ï¼Ÿ[Y/N]${WHITE}" ""
			read op
			case $op in
			y|Y)				
				rm -rf "$runfile"
				;;
			*)
				return 0
				;;
			esac
		fi
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		_msg W "å¦‚æœç½‘é€Ÿè¿‡æ…¢ï¼Œè¯·ç§‘å­¦ä¸Šç½‘"
		_command "-raw" "wget -O $runfile" "$SPEEDTEST_RAW"
		chmod +x $runfile
		_msg I "å®‰è£…å®Œæˆï¼"
		_enter
	}
	_run(){
		clear
		runfile=$PREFIX/bin/speedtest-cli
		 [ ! -e "$runfile" ] && _msg E "è¯·å…ˆå®‰è£…SpeedTest" && _enter && return 0
		 $runfile --bytes
		 _enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½SpeedTest"
         "æµ‹ç½‘é€Ÿ"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’SpeedTest" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _run
			;;
		*)
			return 0
			;;
	esac
}

_chatgpt_on_wechat(){
	_i(){
		_checkInstall "$PREFIX/opt/chatgpt-on-wechat" && rm -rf $PREFIX/opt/chatgpt-on-wechat || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		mkdir -p $PREFIX/opt
		cd $PREFIX/opt
		_command "git clone --depth 1" " https://github.com/zhayujie/chatgpt-on-wechat"
		cat <<-EOF> $PREFIX/opt/chatgpt-on-wechat/config.json
		{
		  "open_ai_api_key": "ChatGPT api",
		  "model": "gpt-3.5-turbo",
		  "proxy": "",
		  "use_azure_chatgpt": false,
		  "single_chat_prefix": ["bot", "@bot"],
		  "single_chat_reply_prefix": "[bot] ",
		  "group_chat_prefix": ["@bot"],
		  "group_name_white_list": ["ChatGPTæµ‹è¯•ç¾¤", "ChatGPTæµ‹è¯•ç¾¤2"],
		  "group_chat_in_one_session": ["ChatGPTæµ‹è¯•ç¾¤"],
		  "image_create_prefix": ["ç”»", "çœ‹", "æ‰¾"],
		  "speech_recognition": false,
		  "voice_reply_voice": false,
		  "conversation_max_tokens": 1000,
		  "expires_in_seconds": 3600,
		  "character_desc": "ä½ æ˜¯ChatGPT, ä¸€ä¸ªç”±OpenAIè®­ç»ƒçš„å¤§å‹è¯­è¨€æ¨¡å‹, ä½ æ—¨åœ¨å›ç­”å¹¶è§£å†³äººä»¬çš„ä»»ä½•é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€ä¸äººäº¤æµã€‚"
		}
		EOF
		_command "pip3 uninstall" "itchat-uos" "-y"
		_command "pip3 install" "itchat-uos==1.5.0.dev0"
		_command "pip3 install --upgrade" "openai"
		loginpy="$(pip3 show itchat-uos | grep Location | awk '{print $2}')/itchat/components/login.py"
		row=$(cat $loginpy | grep -n 'isLoggedIn = False' | awk -F ":" '{print $1}')
		if [ -z "$(sed -n "$(($row+1))"p $loginpy | grep time)" ];then
			sed -i "$row{s/$/\n        time.sleep(30)/}" $loginpy
		fi
		
		echo -e "${YELLOW}æ‹‰å–æˆåŠŸï¼${WHITE}"
		_enter
	}
	_run(){
		[ ! -e "$PREFIX/opt/chatgpt-on-wechat" ] && _msg E "è¯·å…ˆæ‹‰å–é¡¹ç›®ï¼" && _enter && return 0
		p=$(ps -ef | grep "python3 app.py" | grep -v grep | awk '{print $2}')
		kill -9 $p >/dev/null 2>&1
		echo -e "${YELLOW}ä½ çš„é…ç½®æ–‡ä»¶ä¿¡æ¯å¦‚ä¸‹ï¼š${WHITE}"
		echo -e "${YELLOW}é…ç½®æ–‡ä»¶è·¯å¾„ï¼š$PREFIX/opt/chatgpt-on-wechat/config.json${WHITE}"
		cat $PREFIX/opt/chatgpt-on-wechat/config.json
		
		_enter
		rm -rf $PREFIX/opt/chatgpt-on-wechat/nohup.out
		cd $PREFIX/opt/chatgpt-on-wechat
		
		
		out=$HOME/.cache/chatgpt
		mkdir -p $out
		PID=$out/pid
		out=$out/nohup.out
		
		cat <<-EOF> $PREFIX/opt/chatgpt-on-wechat/run.sh
			cd $PREFIX/opt/chatgpt-on-wechat
			echo "\$\$" > $PID
			python3 $PREFIX/opt/chatgpt-on-wechat/app.py
		EOF
		nohup echo $$ > $PID && python3 $PREFIX/opt/chatgpt-on-wechat/app.py > $out  &
		
		sleep 3
		while :
		do
			cat $out
			echo -e "${RED}5s åˆ·æ–°ä¸€æ¬¡æ§åˆ¶å°æ—¥å¿— PIDï¼š$(cat $PID)${WHITE}"
			echo -e "${RED}æ—¥å¿—æ–‡ä»¶ç›®å½•ï¼š$out${WHITE}"
			echo -e "${RED}å¯ä»¥ Ctrl + c ç»“æŸè„šæœ¬ï¼Œä½†ä¸å½±å“ChatGPTè¿è¡Œ${WHITE}"
			for x in $(seq 1 5)
			do
				echo -e "${YELLOW}$x${WHITE}"
				sleep 1
			done
		done
		_enter
	}
	_stop(){
		[ ! -e "$PREFIX/opt/chatgpt-on-wechat" ] && _msg E "è¯·å…ˆæ‹‰å–é¡¹ç›®ï¼" && _enter && return 0
		p=$(ps -ef | grep "python3 $PREFIX/opt/chatgpt-on-wechat/app.py" | grep -v grep | awk '{print $2}')
		_command "kill -9 $p "
		_enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½chatgpt-on-wechat"
         "å¯åŠ¨"
         "åœæ­¢"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’chatgpt-on-wechat" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _run
			;;
		3)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
	
}

_ftpd(){
	_run(){
		_command "sv-enable ftpd"
        _command "sv up ftpd"
		echo -e "$(
			cat<<-EOF
			${GREEN}ftpè¿æ¥ä¿¡æ¯ï¼šï¼š${WHITE}
			    ${RED}ç”¨æˆ·åï¼š${WHITE}   $(whoami)
			    ${RED}å¯†ç ï¼š${WHITE}   å¯ä»¥ä½¿ç”¨passwdå‘½ä»¤ï¼Œä¿®æ”¹å¯†ç ï¼ˆé»˜è®¤æ— å¯†ç ï¼‰
			    ${RED}åœ°å€ï¼š${WHITE}   0.0.0.0
			    ${RED}ç«¯å£ï¼š${WHITE}   8021
			EOF
		)"
        _enter
    }
    _stop(){
		_command "sv-disable ftpd"
        _command "sv down ftpd"
        _enter
    }
    OPTIONS=(
         "å¯åŠ¨ftpd"
         "åœæ­¢ftpd"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’ftpd" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
		1)
			_node _run
			;;
		2)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

# CPUè·‘åˆ†
_benchmarking(){
    echo -e  "${BLUE}[*]${GREEN}bash <(curl -s 'https://raw.githubusercontent.com/masonr/yet-another-bench-script/master/yabs.sh')${WHITE}"
    bash <(curl -s "https://raw.githubusercontent.com/masonr/yet-another-bench-script/master/yabs.sh")
    _enter
}

# aria2
_aria2(){
	_i(){
		clear
		echo -e "$(
			cat<<-EOF
			${GREEN}ç®€ä»‹ï¼š${WHITE}aria2æ˜¯ä¸€æ¬¾å¼€æºçš„C++ç¼–å†™çš„å‘½ä»¤è¡Œä¸‹è½½å™¨ã€‚
			${GREEN}å®˜ç½‘ï¼š${WHITE}https://github.com/P3TERX/aria2.conf
			${RED}ç¯å¢ƒè¦æ±‚ï¼š${WHITE}
			\t\tâ—aria2
			\t\tâ—nginx
			EOF
		)"
		_checkInstall "$PREFIX/opt/aria2" && rm -rf $PREFIX/etc/nginx/config/aria2.conf || return 0
		echo -en "${RED}æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ[Y/N]${WHITE}" ""
		read op
		[[ ! "$op" == "y" && ! "$op" == "Y" ]] && return 0
		[ -z "$(command -v aria2c)" ] && _command "pkg i -y" "aria2"
		[ -z "$(command -v nginx)" ] && _command "pkg i -y" "nginx"
		# install aria2.conf
		mkdir -p "$PREFIX/opt/"
		cd "$PREFIX/opt/"
		_command "git clone --depth 1" "https://github.com/P3TERX/aria2.conf" "$PREFIX/opt/aria2"
		cd aria2
		touch aria2.session
		# ä¿®æ”¹é…ç½®
		sed -i "s#$(cat $PREFIX/opt/aria2/aria2.conf | grep 'dir=')#dir=$HOME/storage/shared/Download/#g" aria2.conf
		sed -i "s#$(cat $PREFIX/opt/aria2/aria2.conf | grep 'input-file=')#input-file=$PREFIX/opt/aria2/aria2.session#g" aria2.conf
		sed -i "s#$(cat $PREFIX/opt/aria2/aria2.conf | grep 'save-session=')#save-session=$PREFIX/opt/aria2/aria2.session#g" aria2.conf
		sed -i "s#$(cat $PREFIX/opt/aria2/aria2.conf | grep 'rpc-secret=')#rpc-secret=threedays#g" aria2.conf

		# nginxé…ç½®
		file="$PREFIX/etc/nginx/nginx.conf"
		if [ -z "$(cat $file | grep 'include config/\*.conf;')" ];then
			row=$(cat $file |grep -n } | sed -n 12p | awk -F ":" '{print $1}')
			sed -i "$(($row-1))i include config/*.conf;" $file
		fi
		mkdir -p $PREFIX/etc/nginx/config
		cat<<-EOF> $PREFIX/etc/nginx/config/aria2.conf
			server {
			    listen       2020;
			    #listen       [::]:80;			ipv6
			    server_name  localhost;
			    location / {
			        root   $PREFIX/opt/aria2;		# æœåŠ¡1çš„å‰ç«¯æ–‡ä»¶å­˜æ”¾çš„åœ°å€
			        index  index.html index.htm;									# æŒ‡å®šé»˜è®¤è®¿é—®çš„é¡µé¢
			    }
		    }
		EOF

		_msg I "aria2å®‰è£…æˆåŠŸï¼"
		_enter
	}
	_start(){
		clear
		[ ! -e "$PREFIX/opt/aria2" ] && _msg E "è¯·å…ˆå®‰è£…aria2ï¼" && _enter && return 0
		path="$PREFIX/var/service/aria2"
		if [ ! -e "${path}" ];then
			mkdir -p ${path}/log
			# exec
			cat<<-EOF>${path}/run
			#!/data/data/com.termux/files/usr/bin/bash
			cd "$HOME"
			exec aria2c --conf-path=$PREFIX/opt/aria2/aria2.conf
			EOF
			chmod +x ${path}/run
			# log
			cat<<-EOF>${path}/log/run
			#!/data/data/com.termux/files/usr/bin/bash
			svlogger="$PREFIX/share/termux-services/svlogger"
			exec "\${svlogger}" "\$@"
			EOF
			chmod +x ${path}/log/run
		fi
		_command "sv-enable aria2"
		_command "sv-enable nginx"
		_msg W "aria2é»˜è®¤ä¸‹è½½è·¯å¾„ï¼š$HOME/storage/shared/Download"
		_enter
	}
	_stop(){
		clear
		[ ! -e "$PREFIX/opt/aria2" ] && _msg E "è¯·å…ˆå®‰è£…aria2ï¼" && _enter && return 0
		_command "sv-disable aria2"
		_command "sv-disable nginx"
		_enter
	}
	_open_settings(){
		clear
		[ ! -e "$PREFIX/opt/aria2" ] && _msg E "è¯·å…ˆå®‰è£…aria2ï¼" && _enter && return 0
		password=$(cat $PREFIX/opt/aria2/aria2.conf | grep 'rpc-secret' | awk -F "=" '{print $2}')
		
		# xdg-open æˆ– termux-open
		termux-open http://localhost:2020/#!/settings/rpc/set/ws/127.0.0.1/6800/jsonrpc/$(echo -n "$password" | base64)
        _enter
	}
    OPTIONS=(
         "å®‰è£…ï½œå¸è½½aria2-web-GUI"
         "æ‰“å¼€aria2æ§åˆ¶é¢æ¿"
         "å¯åŠ¨æœåŠ¡"
         "å…³é—­æœåŠ¡"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>")
   _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹â†’aria2" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
   		1)
   			_node _i
   			;;
		2)
			_node _open_settings
			;;
		3)
			_node _start
			;;
		4)
			_node _stop
			;;
		*)
			return 0
			;;
	esac
}

# main
_otherOP(){
    OPTIONS=(
         "VScode-server"
         "Alist"
         "nvimIDE"
         "filebrowseræ–‡ä»¶ç®¡ç†å™¨"
         "çŒ›çŠ¸å……ç”µ"
         "è§£é”ç½‘æ˜“äº‘ç°è‰²æ­Œæ›²"
         "éŸ³ä¹ä¸‹è½½å™¨music-dl"
         "Wiki.js"
         "wordpress"
         "phpMyAdmin"
         "TreeSoft"
         "æ•°æ®åº“"
         "SpeedTestç½‘ç»œæµ‹é€Ÿ"
         "chatgpt-on-wechat"
         "ftpd"
         "termuxæ€§èƒ½è·‘åˆ†"
         "aria2-web-GUI"
         "<<è¿”å›ä¸Šçº§ç›®å½•>>"
         "é€€å‡ºè„šæœ¬")
    _dialog "é¦–é¡µâ†’å…¶ä»–é€‰é¡¹" "è¯·é€‰æ‹©" $OPTIONS
    case $op in
    	1)
    		_node _vscode-server
    		;;
    	2)
    		_node _Alist
    		;;
    	3)
    		_node _nvimIDE
    		;;
    	4)
    		_node _filebrowser
    		;;
    	5)
    		_node _mmcd
    		;;
    	6)
    		_node _UnblockNeteaseMusic
    		;;
    	7)
    		_node _music-dl
    		;;
    	8)
    		_node _wikijs
    		;;
    	9)
    		_node _wordpress
    		;;
    	10)
    		_node _phpMyAdmin
    		;;
    	11)
    		_node _TreeSoft
    		;;    	
    	12)
    		_node _sql
    		;;    	
    	13)
    		_node _speed
    		;;    	
    	14)
    		_node _chatgpt_on_wechat
    		;;    	
    	15)
    		_node _ftpd
    		;;
    	16)
    		_benchmarking
    		;;
    	17)
    		_node _aria2
    		;;    		
    	18)
    		return 0
    		;;
    	*)
    		exit
    		;;
    esac
}


